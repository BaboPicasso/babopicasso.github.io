<!DOCTYPE html>
<html>
  <head>
    <title>Trägheitsmoment</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="stylesheets/materialize.min.css"  media="screen,projection"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
      h5 {
        text-align: center;
        padding: 30px;
        color: white;
      }
      .content {
        padding: 0px 10px 10px 10px;
      }
      a:visited {
        color:white;
      }
      a:active {
        color: white;
      }
      a {
        color: white;
      }
    </style>
    <style>

      input[type=range]::-webkit-slider-thumb {
        background-color: #1565C0;
      }
      input[type=range]::-moz-range-thumb {
        background-color: #1565C0;
      }
      input[type=range]::-ms-thumb {
        background-color: #1565C0;
      }

      /***** These are to edit the thumb and the text inside the thumb *****/
      input[type=range] + .thumb {
        background-color: #1565C0;
      }
      input[type=range] + .thumb.active .value {
        color: white;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <h5 class="blue darken-3" style="margin: 0">Trägheitsmoment Messung</h5>
      <div class="content">
        <table>
          <tr>
            <td>
              <span>Messdauer</span>
            </td>
            <td>
              <form action="#">
                <p class="range-field">
                  <input type="range" id="duration" min="5" max="30" value="10" />
                </p>
              </form>
            </td>
          </tr>
          <tr>
            <td>
              <span>Messverzögerung</span>
            </td>
            <td>
              <form action="#">
                <p class="range-field">
                  <input type="range" id="delay" min="1" max="10" value="3" />
                </p>
              </form>
            </td>
          </tr>
        </table>
        <table>
          <tr>
            <td><button class="btn blue darken-3 btn-large waves-effect waves-light" onclick="toggleMeasurement()">Messung</button></td>
            <td>
              <div id="measurement-preloader" class = "preloader-wrapper small">
                <div class = "spinner-layer spinner-blue-only">
                  <div class = "circle-clipper left">
                    <div class = "circle"></div>
                  </div>
                  <div class = "gap-patch">
                    <div class = "circle"></div>
                  </div>
                  <div class = "circle-clipper right">
                    <div class = "circle"></div>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          <tr>
            <td><button class="btn blue darken-3 btn-large waves-effect waves-light" onclick="analyseData()">Auswertung</button></td>
            <td>
              <div class = "input-field col s6">
                <label for = "T">Schwingungsdauer</label>
                <input id = "T" type = "text" placeholder = "Ergebnis..."
                       readonly />
              </div>
            </td>
          </tr>
          <tr>
            <td colspan="2">
              <button class="btn blue darken-3 btn-large waves-effect waves-light" style="width: 100%" onclick="saveMeasurements()"><a id="download">Messdaten herunterladen</a></button>
            </td>
          </tr>
        </table>
      </div>
    </div>
    <script>
        let data = {
          gyroscope: {
            t: [],
            x: [],
            y: [],
            z:[]
          },
          accelerometer: {
            t: [],
            x: [],
            y: [],
            z: []
          }
        };
        let date = new Date();
        let display = document.getElementById('display');
        let enableMeasurement = false;

        function initSensors() {
          let gyroscope = new Gyroscope({frequency: 60});
          gyroscope.onreading = () => {
            if(enableMeasurement) {
              data.gyroscope.x.push(gyroscope.x);
              data.gyroscope.y.push(gyroscope.y);
              data.gyroscope.z.push(gyroscope.z);
              data.gyroscope.t.push(new Date().getTime() - date.getTime());
            }
          };
          gyroscope.onerror = event => {
            if (event.error.name == 'NotReadableError') {
              alert("Gyroskop nicht verfügbar.");
            }
          }
          gyroscope.start();

          let accelerometer = new Accelerometer({frequency: 60});
          accelerometer.onreading = () => {
            if(enableMeasurement) {
              data.accelerometer.x.push(accelerometer.x);
              data.accelerometer.y.push(accelerometer.y);
              data.accelerometer.z.push(accelerometer.z);
              data.accelerometer.t.push(new Date().getTime() - date.getTime());
            }
          }
          accelerometer.onerror = event => {
            if (event.error.name == 'NotReadableError') {
              alert("Beschleunigungssensor nicht verfügbar.");
            }
          }
          accelerometer.start();
        }

        function flushData() {
          data.gyroscope.x = [];
          data.gyroscope.y = [];
          data.gyroscope.z = [];
          data.gyroscope.t = [];
          data.accelerometer.x = [];
          data.accelerometer.y = [];
          data.accelerometer.z = [];
          data.accelerometer.t = [];
        }

        function toggleMeasurement() {
          if(!enableMeasurement) {
            flushData();

            setTimeout(function() {
              enableMeasurement = true;
              date = new Date();
              saveMeasurements();
            }, document.getElementById("delay").value * 1000);

            setTimeout(function() {
              enableMeasurement = false;
              document.getElementById("measurement-preloader").className = "preloader-wrapper small";
              saveMeasurements();
            }, document.getElementById("duration").value * 1000 + document.getElementById("delay").value * 1000);

            document.getElementById("measurement-preloader").className = "preloader-wrapper small active";
          } else {
            enableMeasurement = false;

            document.getElementById("measurement-preloader").className = "preloader-wrapper small";
          }
        }

        function saveMeasurements() {
          let csv = "";
          //csv += "Gyroskop Zeit, Gyroskop X, Gyroskop Y, Gyroskop Z, Beschleunigung Zeit, Beschleunigung X, Beschleunigung Y, Beschleunigung Z \n"
          for(let i = 0; i < data.gyroscope.x.length; i++) {
            csv += data.gyroscope.t[i] + ",";
            csv += data.gyroscope.x[i] + ",";
            csv += data.gyroscope.y[i] + ",";
            csv += data.gyroscope.z[i] + ",";

            csv += data.accelerometer.t[i] + ",";
            csv += data.accelerometer.x[i] + ",";
            csv += data.accelerometer.y[i] + ",";
            csv += data.accelerometer.z[i] + "\n";
          }

          let filename = 'export.csv';

          if (!csv.match(/^data:text\/csv/i)) {
            csv = 'data:text/csv;charset=utf-8,' + csv;
          }
          let csvData = encodeURI(csv);

          let link = document.getElementById('download');
          link.setAttribute('href', csvData);
          link.setAttribute('download', filename);
        }

        function analyseData() {
          let zeroTimes = [];

          let z = data.gyroscope.z;
          let direction = Math.sign(z[0]);
          let length = data.gyroscope.z.length;

          for(let i = 1; i < length; i++) {
            if(direction != Math.sign(z[i])) {
              zeroTimes.push(data.gyroscope.t[i] / 1000);
              direction *= -1;
            }
          }

          let deltaT = 0;

          for(let i = 0; i < zeroTimes.length - 1; i++) {
            deltaT += zeroTimes[i + 1] - zeroTimes[i];
          }

          console.log(zeroTimes);

          deltaT = deltaT / (zeroTimes.length - 1) * 2;

          document.getElementById("T").value = Math.round(deltaT * 1000) / 1000 + " s";
        }

        initSensors();
      </script>
    <script type="text/javascript" src="javascripts/materialize.min.js"></script>
  </body>
</html>
